global
    log /dev/log local0
    log /dev/log local1 notice
    maxconn 4096
    user haproxy
    group haproxy
    ssl-default-bind-ciphers TLS13-AES-256-GCM-SHA384:TLS13-AES-128-GCM-SHA256:TLS13-CHACHA20-POLY1305-SHA256:EECDH+AESGCM:EDH+AESGCM
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# HTTPS/HTTP Frontend
frontend https-in
    bind *:443 ssl crt /etc/haproxy/pvpvai.com.pem crt /etc/haproxy/real-trump.fun.pem crt /etc/haproxy/oh-fuck-did-someone-see-this.com.pem crt /etc/haproxy/neilei.dev.pem
    bind *:80
    http-request redirect scheme https unless { ssl_fc }
    
    # Define ACLs based on host and path
    acl host_pvpvai hdr(host) -i pvpvai.com
    acl host_trump hdr(host) -i real-trump.fun
    acl host_canibeton hdr(host) -i oh-fuck-did-someone-see-this.com
    acl host_neilei hdr(host) -i neilei.dev
    
    acl path_agent path_beg /pvpvai/agent
    acl path_api path_beg /pvpvai/api
    acl path_rule34 path_beg /rule34
    acl path_image_analysis_mcp path_beg /image-analysis/mcp
    acl path_image_analysis path_beg /image-analysis
    acl path_torus path_beg /torus
    acl path_canibeton path_beg /canibeton
    
    # Route based on host and path combinations
    # Note: More specific paths should come first
    use_backend image-analysis if host_trump path_image_analysis_mcp
    use_backend image-analysis if host_trump path_image_analysis
    use_backend pvpvai-agent if host_pvpvai path_agent
    use_backend pvpvai-api if host_pvpvai path_api
    use_backend rule34-agent if host_neilei path_rule34
    use_backend trump-fun-torus if host_trump path_torus
    use_backend canibeton-api if host_canibeton path_canibeton

# Your existing HTTP backends
backend pvpvai-agent
    balance roundrobin
    http-request replace-path /pvpvai/agent(.*) \1
    http-request replace-path ^$ /
    server agent1 127.0.0.1:3000 check

backend pvpvai-api
    balance roundrobin
    http-request replace-path /pvpvai/api(.*) \1
    http-request replace-path ^$ /
    server backend1 127.0.0.1:3001 check

backend rule34-agent
    balance roundrobin
    http-request replace-path /rule34(.*) \1
    http-request replace-path ^$ /
    server rule34-agent1 127.0.0.1:3014 check

backend trump-fun-torus
    balance roundrobin
    http-request replace-path /torus(.*) \1 
    http-request replace-path ^$ /
    server backend2 127.0.0.1:3010 check

backend image-analysis
    balance roundrobin
    http-request replace-path ^/image-analysis$ /
    http-request replace-path ^/image-analysis/(.*)$ /\1
    server image-analysis1 127.0.0.1:3011 check

backend canibeton-api
    balance roundrobin
    http-request replace-path /canibeton(.*) \1
    http-request replace-path ^$ /
    server backend3 127.0.0.1:5000 check 